94424*02*vm1747*18*crypt.pydef xor_bytes(content,password,start_p=0):    #start_p:從第幾個password開始循環加密
    content_bytes=list(content)
    content_length=len(content)
    password_bytes=list(password)
    p_len = len(password)
    password_box=password_bytes[start_p%p_len:]
    link_times=(content_length-len(password_box))//p_len
    password_box+=password_bytes*link_times
    password_box+=password_bytes[:content_length-len(password_box)]
    void_byte=[a^b for a,b in zip(content_bytes,password_box)]
    return bytes(void_byte)
def generate_password(password,length): #密碼,最短長度
    def generate(password_bytes):
        void_password=[]
        for b in range(2):
            for i in range(len(password_bytes)-1-b):
                void_password.append((password_bytes[i]^password_bytes[i+1+b]+password_bytes[i])%256)
        return void_password
    if len(password)==0:
        password=b'123'
    while len(password)<4:
        password+=xor_bytes(password,b'azbycx')     #增加亂數，若密碼>4就不增加亂數
    password_bytes = list(password)
    #增加變化
    for i in range(len(password_bytes)):
        password_bytes[i]+=i
    password_bytes = generate(password_bytes)       #至少要generate一次
    while len(password_bytes)<length:
        password_bytes=generate(password_bytes)
    return bytes(password_bytes)

if __name__ == '__main__':
    string=b'hello world,this is my first program. In this project,I make an encrypt function.'
    password=b'all'
    password2 = generate_password(password, 100)
    encrypt=xor_bytes(string,password2,0)
    print(len(encrypt)==len(string))
    k=8
    decrypt=xor_bytes(encrypt[k:],password2,k)
    print(decrypt)
2082*112*real_disk.pyfrom os import listdir,mkdir,rmdir,getcwd,rename,remove,chdir,popen
from os.path import isdir,isfile,getsize,isabs

class RDisk:
    def __init__(self):
        self.work_folder=getcwd().replace('\\','/')
    def __relatively_to_absolute(self,filepath):
        if isabs(filepath):     #絕對路徑
            return filepath
        return f'{self.work_folder}/{filepath}'
    def listdir(self,foldername=None):
        if foldername==None:
            foldername=self.work_folder
        foldername=self.__relatively_to_absolute(foldername)
        if foldername==None:
            return listdir(self.work_folder)
        return listdir(foldername)
    def mkdir(self,foldername):
        folderpath=self.__relatively_to_absolute(foldername)
        if not isdir(folderpath):
            mkdir(folderpath)
    def rmdir(self,foldername):
        rmdir(self.__relatively_to_absolute(foldername))
    def getcwd(self):
        return self.work_folder
    def rename(self,filename1,filename2):
        rename(self.__relatively_to_absolute(filename1),self.__relatively_to_absolute(filename2))
    def remove(self,filepath):
        remove(self.__relatively_to_absolute(filepath))
    def chdir(self,foldername):
        if isdir(foldername):
            self.work_folder=self.__relatively_to_absolute(foldername.replace('\\','/').rstrip('/'))
    def isfile(self,filepath):
        return isfile(self.__relatively_to_absolute(filepath))
    def isdir(self,folderpath):
        return isdir(self.__relatively_to_absolute(folderpath))
    def getsize(self,filepath):
        return getsize(self.__relatively_to_absolute(filepath))
    def open(self,filepath,*args,**kwargs):
        filepath=self.__relatively_to_absolute(filepath)
        return open(filepath,*args,**kwargs)
    def popen(self,command):
        mypath = getcwd()
        chdir(self.work_folder)
        result=popen(command)
        chdir(mypath)
        return result
    def close(self):    #為了配合virtual disk而設立的函數
        pass
5401*111*terminal.pyfrom time import time

t_cmd='''
終端機指令:

help                               查看可用指令
system                             查看系統資訊

input    filepath                  將filepath存入虛擬磁碟
output   v_filename r_filename     將v_filename從虛擬磁碟匯出，並命名為r_filename
mkdir    foldername                創建foldername資料夾
cd       foldername                進入資料夾
cd..                               離開資料夾
dir      foldername                查看foldername底下所有檔案資料
info     filename                  查看filename資訊
remove   filename                  移除filename


'''
class Terminal:                      #磁碟操作系統
    def __init__(self,disk,mode=0):          #mode[0:印出結果,1:記錄在output,2:無紀錄]
        self.disk=disk
        self.banlist='/\\:*?"<>|'
        self.folderpath=''
        self.log_text=[]                      #事件紀錄
        self.output=[]
        self.error=0
        self.mode=mode
    def log(self,msg,error=1):
        self.log_text.append((time(),error,msg))
        if self.mode==0:print(msg)
        elif self.mode==1:self.output.append(msg)
        self.error=error
    def operate(self,string):                      #執行命令
        self.log_text.append((time(),0,string))
        cmd=string.split(' ')
        if cmd[0]=='help':print(t_cmd,end='')
        elif cmd[0]=='system':
            disk.recalculate_size()
            self.log(f'已使用空間:{esize(disk.used_size)}')
            self.log(f'系統所占空間:{esize(disk.fdsc_size+disk.fdc_size+disk.fsc_size)}')
        elif cmd[0]=='cd..':
            folder=self.folderpath.split('/')[-1]
            self.folderpath=self.folderpath[:-len(folder)-1]
        elif len(cmd)==1 and cmd[0]=='dir':
            self.log('\n'.join(self.disk.listdir(self.folderpath)))
        elif len(cmd)>1:
            filename=cmd[1]
            check_code=0                       #0代表合格
            if len(filename)==0:
                self.log('檔案名稱不可為空!')
                check_code=2                    #2代表不合格
            for i in self.banlist:
                if i in filename:
                    if i in '/\\':
                        check_code=1        #1代表檔名可能使用絕對路徑
                    else:
                        self.log(f'檔案名稱"{filename}"中包含不可使用的字元:{i}')
                        check_code=2                                                 #2代表不合格
           # print('1 self.folderpath:',self.folderpath)
            if check_code==1:
                fpath=filename
            elif self.folderpath == '':
                fpath = filename
            else:
                fpath = self.folderpath + '/' + filename
           # print('2 self.folderpath:',self.folderpath)
            print('fpath:',fpath)
            if check_code<2:

                file = self.disk.fopen(fpath, mode=0)
                if cmd[0]=='mkdir':
                    if file!=-1:
                        if file.type==0:self.log('該資料夾已存在')
                        else:self.log('此為已存在的檔案名稱')
                    else:self.disk.mkdir(fpath)
                if cmd[0]=='cd':
                    if file!=-1 and file.type==0:self.folderpath=fpath
                    else:self.log('該資料夾不存在!')
                elif cmd[0]=='dir':
                    if file!=-1 and file.type==0:self.log('\n'.join(self.disk.listdir(fpath)))
                    else:self.log('該資料夾不存在!')
                elif cmd[0]=='info':
                    if file!=-1:self.log(file.get_info())
                    else:self.log('該檔案不存在!')
                elif cmd[0]=='remove':
                    if file!=-1:self.disk.remove(fpath)
                    else:self.log('該檔案不存在!')
                elif cmd[0] == 'input':
                    if path.isfile(cmd[1]) or path.isdir(cmd[1]):
                        # print('fpath:',fpath)
                        check = self.disk.input(self.folderpath, cmd[1],progress_func=progress_bar)
                        if check == -1: self.log('無效的虛擬路徑')
                    else:
                        self.log(f'{cmd[1]}不存在!')
                elif len(cmd)>2:
                    if cmd[0]=='output':
                        if path.isfile(cmd[2]):
                            self.log('無法覆蓋現有的檔案!')
                        else:
                            check=self.disk.output(fpath,cmd[2])
                            if check==-1:self.log('該虛擬檔案不存在')
        print(f'\n{disk.disk_path}#{self.folderpath}>>',end='')
    def mainloop(self):
        self.operate('help')
        while True:
            a=input()
            if a=='exit':break
            elif a=='format':
                self.disk.format()
                self.folderpath=''
            else:
                b=a.split(' ')
                if b[0]=='ptr':
                    file=FILE(self.disk,b[1])
                    if file.type==0:
                        print(file.read(0,0))
                else:
                    self.operate(a)740*17*tool.pyfrom socket import socket,AF_INET,SOCK_DGRAM,timeout,gethostname,gethostbyname
def display_size(size):   #Byte轉size
    for i in range(4):
        base=2**((3-i)*10)
        if size>base:
            return f'{round(size/base,2)}'+('GB','MB','KB','bit')[i]
def Default_progress_bar(now,total,width=50,hint=''):
    process=int(width*now/total)
    print('\rprocess:['+'▇'*process+' '*(width-process)+f']  {round(100*now/total,2)}%  {hint}',end='  ')
def get_host_ip():
    s = socket(AF_INET,SOCK_DGRAM)
    s.settimeout(2)
    try:
        s.connect(("8.8.8.8", 80))    #https://dns.google/
        ip=s.getsockname()[0]
    except timeout:
        ip=gethostbyname(gethostname())
    s.close()
    return ip42241*115*virtual_disk.pyfrom os import path,listdir
from time import time,localtime,sleep
from vm.crypt import xor_bytes,generate_password
from vm.real_disk import RDisk
from vm.tool import display_size,Default_progress_bar
from vm.writer import FWriter
'''
檔案系統，每個單位是1024Byte

'''
def progress_bar(now_size,total_size,size=50):
    i=int(size*now_size/total_size)
    print('\r[' + '#' * i + ' ' * (size - i) + f'] {esize(now_size)}/{esize(total_size)}', end='')
def nowtime(t):
    nt=localtime(t)
    return f'{nt.tm_year}/{nt.tm_mon}/{nt.tm_mday} {nt.tm_hour}:{nt.tm_min}:{nt.tm_sec}'
def esize(size):
    size_unit=('B','KB','MB','GB','TB','PB','EB')
    for i in range(len(size_unit)):
        csize=round(size/(2**(10*i)),2)
        if csize<1024:
            return f'{csize} {size_unit[i]}'
def legel_filename(filename):
    format=filename.split('.')[-1]
    name=filename[:-len(format)-1]
    banlist = '/\\:*?"<>|'
    for i in banlist:
        name = name.replace(i, '_')
    o=listdir()
    if f'{name}.{format}' not in o:return f'{name}.{format}'
    c=1
    while f'{name}_{c}.{format}' in o:
        c+=1
    return f'{name}_{c}.{format}'
def format_file_size(size):  # size為byte大小
    s = str(int(size)).encode('utf-8')
    a = '0'.encode('utf-8')
    return a * (15 - len(s)) + s
def file_info(isfile,build_t,last_update_t,last_read_t,file_size,file_location):
    def format_isfile(isfile):
        return ('1' if isfile else '0').encode('utf-8')
    def format_time(t):
        n = str(int(t)).encode('utf-8')
        a='0'.encode('utf-8')
        return a * (10 - len(n)) + n[-10:]
    def format_file_location(location):
        a='0'.encode('utf-8')
        location_byte=location.encode('utf-8')
        return location_byte+a*(67-len(location_byte))
    return format_isfile(isfile)+format_time(build_t)+format_time(last_update_t)+format_time(last_read_t)+format_file_size(file_size)+format_file_size(0)+format_file_location(file_location)

'''通用名詞註記
ptr:在FILE中的位址
dptr:在磁碟中的位址
'''
def text_to_serial(text):                         # 串列格式讀取e.g.   100,200-400,345,356,10-50,57*
    k = text.index('*')
    box=[]
    for i in text[:k].split(','):
        if '-' in i:
            c = i.split('-')
            box.append((int(c[0]), int(c[1])))
        else:
            box.append(int(i))
    return box
def serial_to_text(serial):
    text = ''
    for i in serial:
        if type(i) == int:
            text += f'{i},'
        elif type(i) == tuple:
            text += f'{i[0]}-{i[1]},'
    return text[:-1] + '*'
def sort_serial(serial):
    get={}
    box,nbox=[],[]
    for i in serial:
        if type(i)==int:
            get[i]=i
            box.append(i)
        elif type(i)==tuple:
            get[i[0]]=i
            box.append(i[0])
    box.sort()
    for i in box:
        nbox.append(get[i])
    return combine_serial(nbox)
def combine_serial(serial):
    tem=[0,'no']
    result=[]
    c=0
    while c<len(serial):
        if type(serial[c])==int:deal=(serial[c],serial[c]+1024)
        else:deal=serial[c]
        if deal[0]==tem[1]:
            tem[1]=deal[1]
        else:
            result.append((tem[0],tem[1]))
            tem=[deal[0],deal[1]]
        c+=1
    result.append((tem[0], tem[1]))
    del result[0]
    return result
class Space_Serial:                                                       #檔案所佔空間序列
    def __init__(self,disk,ptr,extend_ptr,location):
        self.ptr=ptr
        self.disk=disk
        self.ptrs=[extend_ptr]
        while extend_ptr>0:
            if disk.debug:
                print('extend_ptr:',extend_ptr)
            fetch=self.disk.file_describe_space_configuration.read(extend_ptr).decode('utf-8')
            if disk.debug:
                print('fetch:',fetch)
          #  print('fetch:',fetch)
            extend_ptr=int(fetch[:15])
            self.ptrs.append(extend_ptr)          #最後一個ptr必定是0
            location+=fetch[15:128]
      #  print(self.ptrs)
      #  print('location:',location)
        self.serial=text_to_serial(location)
    def now_max_size(self):             #當前所存放的最大空間
        total=0
        for i in self.serial:
            if type(i)==int:
                total+=1
            elif type(i)==tuple:
                total+=(i[1]-i[0])/1024
        return int(total*1024)
    def resize(self,size):                                                   #調整內容大小
        now_max_size=self.now_max_size()
        if size>now_max_size:        #如果空間不足，就申請
            need=(size-now_max_size)//1024+1                    #需要的空間個數
            apply_serial=self.disk.apply_space(need)
            self.serial+=apply_serial
        elif size<now_max_size-1024:
            need=size//1024+1
            abort_serial=[]
            c=0
            while need>0:
                if type(self.serial[c])==int:
                    need-=1
                elif type(self.serial[c])==tuple:
                    deal=[self.serial[c][0],self.serial[c][1]]
                    while need>0 and deal[1]-deal[0]>0:
                        need-=1
                        deal[0]+=1024
                    if deal[1]-deal[0]>0:
                        self.serial[c]=(self.serial[c][0],deal[0])
                        abort_serial.append((deal[0],deal[1]))
                c+=1
            abort_serial+=self.serial[c:]
            self.serial=self.serial[:c]
          #  print('abort:',abort_serial)
            self.disk.release_space(abort_serial)
        self.save()
    def save(self):                                          #儲存
        self.serial=combine_serial(self.serial)
       # print(self.serial)
        byte=serial_to_text(self.serial).encode('utf-8')
        n=len(byte)
        ptrs=[self.ptr]+self.ptrs
        c=0                     #目前為第c個ptr
     #   print('全byte為:',byte)
      #  print('n為:',n)
        while n>0:
            if c==0:n-=67
            else:n-=113
            if n<=0:                       #就此結束
                ptrs[c+1]=0
            else:                          #再申請一個
                if ptrs[c+1]==0:
                    ptrs[c+1]=self.disk.register_describe_configuration()
                    ptrs.append(0)
            if c==0:
              #  print('呼叫fdsc1----------------------')
              #  print('ptrs:',ptrs)
                self.disk.file_describe_space_configuration.write(ptrs[c]+46, format_file_size(ptrs[c+1])+byte[:67])
            else:
                self.disk.file_describe_space_configuration.write(ptrs[c],format_file_size(ptrs[c+1])+byte[c*113-46:c*113+67])
            c+=1
        if c+1<len(ptrs):
            self.disk.unregister_describe_configuration(ptrs[c+1:-1])                   #取消登記
        self.ptrs=ptrs[1:c+1]
        self.disk.save_configuration()
class FDSC:
    def __init__(self,disk,ptr,unit):       #unit為每次擴展單位，為8的倍數
        self.disk=disk
        self.unit=unit
        fetch=self.disk.f.read(ptr,128).decode('utf-8')
        self.dptrs=[ptr,int(fetch[46:61])]
        while self.dptrs[-1]>0:
            fetch=self.disk.f.read(self.dptrs[-1],128)
            self.dptrs.append(int(self.disk.f.read(self.dptrs[-1]+46,15).decode('utf-8')))
        self.max_term=self.__get_max_term()
    def __get_max_term(self):                                  #自身可登記的檔案最大項
        return (len(self.dptrs)-1)*self.unit
    def extend(self,ptr):                 #擴展可用空間
        self.dptrs[-1]=ptr
        #----------------------------------更新舊版面
      #  print('dparts:',self.dptrs)
        #print('extend:',self.dptrs[-2],format_file_size(self.dptrs[-1]))
        self.disk.f.write(self.dptrs[-2] + 46,format_file_size(self.dptrs[-1]))
        #----------------------------------更新新版面
        self.dptrs.append(0)
        #print('extend2:',self.dptrs[-2],format_file_size(self.dptrs[-1]))
        self.disk.f.write(self.dptrs[-2] + 46,format_file_size(self.dptrs[-1]))
        #-----------------------------------更新最大項
        self.max_term=self.__get_max_term()
    def write(self,ptr,content):
        if ptr in self.dptrs:
            print(ptr)
            raise Exception('此位置被占用')
        #  print('給的ptr為:',ptr)
        order = ptr // 128  # 第幾項
        page = order // self.unit  # 第幾頁
        offset = order - self.unit * page  # 第page頁偏移多少
        offset2=ptr-(ptr//128)*128
        dptr = self.dptrs[page] + offset * 128+offset2
        return self.disk.f.write(dptr,content)
    def read(self,ptr):
        order=ptr//128                            #第幾項
        page=order//self.unit                            #第幾頁
        offset=order-self.unit*page              #第page頁偏移多少
        dptr=self.dptrs[page]+offset*128
        if self.disk.debug:
            print('self.dptr:',self.dptrs)
            print('page:',page)
            print('dptr:',dptr)
        return self.disk.f.read(dptr,128)
class FOLDER:
    def __init__(self,disk,ptr,encrypt=None):
        self.disk=disk
        self.ptr=ptr
        self.encrypt=encrypt
        self.file=FILE(self.disk,self.ptr,encrypt=self.encrypt)
        self.file_size=self.file.file_size
        self.type=self.file.type
        self.box=[]
        self.__load_content()
        self.reload()
    def get_info(self):
        self.file.get_info()
    def set_type(self,ty):
        self.file.set_type(ty)
        self.type=ty
    def __load_content(self):
        content = self.file.read(0,0)
        try:
            self.content=content.decode('utf-8')
            self.access_rights=True
            self.set_type(0)
        except UnicodeDecodeError:
            self.content=''
            self.access_rights=False
      #  print('獲取Content:',self.content)
    def reload(self):                     #將self.content轉為可使用list
       # print('reload:',self.content)
        box = self.content.split('|**')[0].split('|')[1:]
        self.box=[]
        for i in range(len(box)):
            name, ptr = box[i].split('*')
            self.box.append([name, int(ptr)])
    def save(self):
        if self.access_rights:
            box=[]
            for name,ptr in self.box:
                box.append(f'|{name}*'.encode('utf-8')+format_file_size(ptr))
            box.append('|**'.encode('utf-8'))
            byte=b''.join(box)
            if self.type==1:
                self.file.set_type(0)
                self.type=self.file.type
          #  self.file.file_size=len(byte)
            self.file.set_size(len(byte))
           # print('\rnow size:',len(byte),end='')
            self.file.write(byte,0)
            content=byte.decode('utf-8')

            self.__load_content()
            if content!=self.content:
                print(content)
                print(self.content)
                raise Exception('stop')
        else:
            raise Exception('folder儲存失敗')
    def listdir(self,fptr=True):
        if len(self.box)==0:self.reload()
        if not fptr:
            box=[]
            for i in self.box:
                box.append(i[0])
            return box
        return self.box
    def get_file_ptr(self,filename):
      #  print('Content:',self.content)
        try:
          #  print('所求檔名:',filename)
            nk=self.content.index(f'|{filename}*')
            pk=self.content.index('*',nk)
            ptr=int(self.content[pk+1:pk+16])
        except:ptr=-1
       # print('get ptr:',ptr)
        return ptr
    def CreatFile(self,filename):
        if not self.access_rights:return -1
        banlist = '/\\:*?"<>|'
        for i in banlist:
            filename = filename.replace(i, '_')
        self.reload()
        login_ptr=self.disk.register_describe_configuration(1)          #獲取登記空間
        space_serial=serial_to_text(self.disk.apply_space(1))
        #print('登記ptr:',login_ptr)
        #print('空間ptr:',space_ptr)
        t=time()
        login_info=file_info(True,t,t,t,0,space_serial)
        #print('登記資訊:',login_info)
       # print('呼叫fdsc')
        self.file.fdsc.write(login_ptr,login_info)
        self.box.append([filename,login_ptr])
        self.save()
        return login_ptr
    def is_exist(self,filename):    #是否存在filename
        for i in self.box:
            if i[0] == filename:
                return i
        return False
    def MoveFile_to_AnotherFolder(self,filename1,filename2,anotherfolder,overwrite=True):
        self.reload()
        file1_info = self.is_exist(filename1)
        if not file1_info:
            print('起始地檔案不存在')
            return -1
        if self.ptr==anotherfolder.ptr:    #代表是同一個資料夾
            file1_info[0]=filename2
        else:
            anotherfolder.reload()
            file2_info = anotherfolder.is_exist(filename2)
            if file2_info:
                if not overwrite:
                    print('目的地檔案名稱已存在')
                    return -1
                anotherfolder.DeleteFile(filename2)  #刪除原有檔案
            self.box.remove(file1_info)
            anotherfolder.box.append(file1_info)
            anotherfolder.save()
        self.save()
        return file1_info[1]
    def DeleteFile(self,name):
        self.reload()
        dptr=-1
        for i in self.box:
            if i[0]==name:
                dptr=i[1]
                self.box.remove(i)
        self.save()
        if dptr!=-1:
            #--------------------釋放檔案資源
            f=FILE(self.disk,dptr,encrypt=self.encrypt)
            f.space_manaager.resize(-1)               #歸還使用空間
            self.disk.unregister_describe_configuration(dptr)
        return dptr
class FILE:                                                             #一般檔案
    def __init__(self,disk,ptr,encoding='binary',encrypt=None):     #磁碟，檔案配置FILE中的ptr
        self.disk=disk
        self.ptr=int(ptr)
        self.encoding=encoding
        self.encrypt=encrypt
        #-----------------------------擷取檔案配置表資訊
        self.fdsc=self.disk.file_describe_space_configuration       #檔案配置表
      #  print('我的ptr為:',ptr)
        fetch=self.fdsc.read(self.ptr)
        fetch=fetch.decode('utf-8')
      #  print('fetch為:',fetch)
      #  print('fetch[0]',fetch[0])
      #  tem=fetch[0]
        assert len(fetch)==128,'fetch error'
        assert type(fetch)==str,'type error'
        try:
            self.type=int(fetch[0])           #型態，占1        #1:檔案，0:資料夾
            self.build_t=int(fetch[1:11])     #建立時間，占10
            self.update_t=int(fetch[11:21])   #上次修改時間，占10
            self.read_t=int(fetch[21:31])     #上次讀取時間，占10
            self.file_size=int(fetch[31:46])  #檔案大小，占15
            extend_ptr=int(fetch[46:61])            #擴充位址，占15
            location=fetch[61:128]       #所占空間位址，占67
        except Exception as e:
            print('fetch error:',fetch)
            raise e
        self.space_manaager=Space_Serial(self.disk,self.ptr,extend_ptr,location)                #所佔空間序列
        #---------------------------------------------------------------
        self.seek(0)                                        #自己的指標(在檔案內)
        self.__set_info('read_t')
    def set_type(self,ty):
        self.type=ty
        self.__set_info('type')
    def set_size(self,size):
        self.file_size=size
        self.__set_info('size')
    def __set_info(self,state):                                 #設定註冊表內容
        if state=='type':s=(0,str(self.type).encode('utf-8'))
        elif state=='update_t':s=(11,str(int(time())).encode('utf-8'))
        elif state=='read_t':s=(21,str(int(time())).encode('utf-8'))
        elif state=='size':s=(31,format_file_size(self.file_size))
        self.fdsc.write(self.ptr+s[0],s[1])
    def get_info(self):
        info=[]
        info.append(f'檔案登記位址:{self.ptr}')
        info.append('檔案型態:'+['資料夾','檔案'][self.type])
        info.append(f'建立時間:{nowtime(self.build_t)}')
        info.append(f'上次修改時間:{ nowtime(self.update_t)}')
        info.append(f'上次存取時間:{nowtime(self.read_t)}')
        info.append(f'檔案大小:{self.file_size}')
        info.append(f'儲存空間序列{self.space_manaager.serial}')
        return '\n'.join(info)
    def seek(self,pen,relative=0):
        self.pen=relative+pen
    def write(self,byte,pen=None):
        if pen!=None:self.pen=pen
        if self.encoding!='binary':
            byte=byte.encode(self.encoding)
        n=len(byte)
        if self.pen+n>=self.file_size:                       #如果寫入時超出可用空間，就申請
            self.file_size=self.pen+n
            self.space_manaager.resize(self.file_size)
            self.__set_info('size')
        if self.encrypt!=None:             #對寫入的byte進行加密
            byte=xor_bytes(byte,self.encrypt,self.pen)
            assert n==len(byte),'加密錯誤'
        c=0               #在serial的位置
        k=0               #在byte中的位置
        skip=0     #前往pen之前所跳過的內容大小(byte)
      #  if self.ptr==512:
      #      print('------------------------------------WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW')
      #      print('要寫的序列為:',self.space_manaager.serial)
       #     print(f'{self.ptr}的pen為',self.pen)
        while c<len(self.space_manaager.serial):
            deal=self.space_manaager.serial[c]
            if skip>=self.pen:                #開始寫入磁碟
               # print(self.ptr,'寫入!')
                if type(deal)==int:
                  #  if self.ptr==512:print('從這裡寫1')
                    self.disk.f.write(deal,byte[k:k+1024])
                    k+=1024
                elif type(deal) == tuple:
                    w_size=deal[1]-deal[0]
                 #   if self.ptr==512:print('從這裡寫2')
                    self.disk.f.write(deal[0],byte[k:k+w_size])
                    k+=w_size
            else:                            #跳過內容
                if type(deal)==int:
                    if skip+1024>self.pen:
                        k=skip+1024-self.pen
                     #   if self.ptr==512:print('從這裡寫3')
                        self.disk.f.write(deal+1024-k,byte[:k])
                    skip+=1024
                elif type(deal)==tuple:
                    w_size=deal[1]-deal[0]
                    if skip+w_size>self.pen:
                        k=w_size-(self.pen-skip)
                    #    if self.ptr==512:print('從這裡寫4')
                        self.disk.f.write(deal[0]+(self.pen-skip),byte[:k])
                    skip+=w_size
            c+=1
            if k>len(byte)-1:break
        self.pen += n
        self.__set_info('update_t')
        return n
    def read(self,n=0,pen=None):
        if n!=0:
            r_size =min(2 ** 20,n)
            code = self.__read(r_size, pen)
            total_byte = [code]
            n-=r_size
            while n > 0:
                r_size = min(2 ** 20, n)
                code = self.__read(r_size)
                if len(code)==0:
                    break
                total_byte.append(code)
                n-=r_size
            return b''.join(total_byte)
        r_size = 2 ** 20                   # 讀取尺寸為1MB
        code =self.__read(r_size,pen)
        total_byte=[code]
        while len(code) > 0:
            code = self.__read(r_size)
            total_byte.append(code)
        return b''.join(total_byte)
    def __read(self,n=0,pen=None):
        def disk_read(dptr,n):
            byte.append(self.disk.f.read(dptr,n))
        if pen != None: self.pen = pen
        read_pen=self.pen
        if n==0:
            n=self.file_size-self.pen
        else:n=min(n,self.file_size-self.pen)
        read_size=n
     #   print('n:',n)
     #   print('pen:',self.pen)
        byte=[]
        c = 0  # 在serial的位置
        skip = 0  # 前往pen之前所跳過的內容大小(byte)
        while c < len(self.space_manaager.serial):
            deal = self.space_manaager.serial[c]
            if skip >= self.pen:                       #返回byte
                if type(deal) == int:
                    r_size=min(1024,n)
                    #print(1)
                    disk_read(deal,r_size)
                    n-=r_size
                elif type(deal) == tuple:
                    r_size =min(deal[1] - deal[0],n)
                   # print(2)
                    disk_read(deal[0], r_size)
                    n-=r_size
            else:                                    # 跳過內容
                if type(deal) == int:
                    if skip + 1024 > self.pen:
                        r_size= min(skip + 1024 - self.pen,n)
                       # print(3)
                        disk_read(deal + 1024 - r_size,r_size)
                        n-=r_size
                    skip += 1024
                elif type(deal) == tuple:
                    t_size = deal[1] - deal[0]
                    if skip + t_size > self.pen:
                        r_size = min(t_size - (self.pen - skip),n)
                       # print(4)
                        disk_read(deal[0] + (self.pen - skip),r_size)
                        n-=r_size
                    skip += t_size
            c += 1
            if n==0:break
        self.pen+=read_size
        self.__set_info('read_t')
        read_byte=b''.join(byte)
        if self.encrypt!=None:             #對讀出的byte進行解密
            read_byte=xor_bytes(read_byte,self.encrypt,read_pen)
            assert read_size==len(read_byte),'解密錯誤'
        if self.encoding!='binary':
            read_byte=read_byte.decode(self.encoding)
        return read_byte
    def close(self):
        self.disk=None
        self.space_manaager=None
class VDisk:
    def __init__(self,disk_path='',password=None):
        self.debug=False
        self.disk_path=disk_path
        self.work_folder='VDisk:'   #磁碟中的相對目錄
        self.fdsc_unit=800
        self.encrypt=generate_password(password.encode('utf-8'),2**10) if password!=None else None    #1MB的加密密鑰
        # -----------------------------------------------------------載入磁碟
        self.__rdisk=RDisk()
        if self.disk_path == '':           #創建新磁碟
            self.disk_path ='default.disk'
        if not path.isdir(self.disk_path):
            print('創建:',self.disk_path)
            self.__create_new_disk()
        self.__load_disk()
    def recalculate_size(self):               #算法:總大小-可申請空位=已使用空間
        total_size=self.file_space_configuration_serial[-1]          #總大小
        size=0
        for i in self.file_space_configuration_serial:
            if type(i)==int:
                size+=1024
            elif type(i)==tuple:
                g_size=i[1]-i[0]
                size+=g_size
        #-------------------------------------計算系統使用空間
        self.fdsc_size=self.file_describe_space_configuration.max_term*128
       # print(self.fdsc_size)
        self.fsc_size=self.fsc.file_size
       # print(self.fsc_size)
        self.fdc_size=self.fdc.file_size
       # print(self.fdc_size)
        self.used_size=total_size-size
       # print(self.used_size)
    def get_info(self):
        self.recalculate_size()
        info_box=[]
        info_box.append(f'used_size:{display_size(self.used_size)}')
        info_box.append(f'access_rights:{self.root.access_rights}')
        return '\n'.join(info_box)
    def format(self):
        self.__create_new_disk()
        self.__load_disk()
    def __create_new_disk(self):                   #創建空磁碟
        self.__rdisk.mkdir(self.disk_path)
        f=FWriter(self.disk_path)
        t=time()
        f.write(0,file_info(True, t, t, t,0, '---'))                                  # 檔案配置檔案fdsc
        f.write(128,file_info(True, t, t, t, 4,f'{int(self.fdsc_unit*128)}*'))              #檔案描述符號登記
        f.write(256,file_info(True, t, t, t, len(f'{self.fdsc_unit*128+1024*3}*'.encode()), f'{int(self.fdsc_unit*128+1024)}*'))              #檔案空間登記
        #--------------------------------------------------
        f.write(384,file_info(False, t, t, t, 0, f'{int(self.fdsc_unit*128+1024*2)}*'))             #根資料夾
        #--------------------------------------------------
        f.write(self.fdsc_unit*128,b'512*')                 #下一個檔案登記位置
        f.write(self.fdsc_unit*128+1024,f'{self.fdsc_unit*128+1024*3}*'.encode())
        f.close()
    def __load_disk(self):            #載入磁碟
        self.f=FWriter(self.disk_path)
        #-----------------------------------------------------------檔案配置管理(檔案配置空位、描述符號空位、檔案空間空位)
        self.file_describe_space_configuration = FDSC(self, 0,unit=self.fdsc_unit)
        #--------------------
        self.fdc=FILE(self,128)           #因為內容與其他磁碟差不多，加密後會被與其他磁碟比對而破解，故無須加密
        self.fsc=FILE(self,256)           #因為內容與其他磁碟差不多，加密後會被與其他磁碟比對而破解，故無須加密
        self.file_describe_configuration_serial=text_to_serial(self.fdc.read(0,0).decode())
        self.file_space_configuration_serial= text_to_serial(self.fsc.read(0, 0).decode())
        self.root=FOLDER(self,384,encrypt=self.encrypt)      #內容和其他磁碟不同，須加密   #根資料夾
        self.save_configuration_lock=0
        self.recalculate_size()                                           #已使用空間
    def register_describe_configuration(self,number=1):                                                         #在檔案列表註冊number個描述配置位址
        serial=self.file_describe_configuration_serial           #讀取登記表
        get=[]
        max_term = self.file_describe_space_configuration.max_term
        while len(get)<number:
            want_use_ptr=serial[0]
            if len(serial) > 1:
                del serial[0]
            elif len(serial) == 1:
                serial[0] += 128
            if want_use_ptr>=max_term:
                extend_ptr=self.apply_space(int(self.fdsc_unit/8),continuous=True)[0][0]         #申請100個連續空間
                self.file_describe_space_configuration.extend(extend_ptr)
                max_term=self.file_describe_space_configuration.max_term
            elif want_use_ptr not in self.file_describe_space_configuration.dptrs:    #此位置不可用
                get.append(want_use_ptr)
        if number==1:return get[0]
        return get
    def unregister_describe_configuration(self,ptrs):                                                               #取消登記位址，int或tuple或serial
        serial=self.file_describe_configuration_serial        #讀取登記表
        if type(ptrs)==list:
            self.file_describe_configuration_serial=serial[:-1]+ptrs+[serial[-1]]
        else:self.file_describe_configuration_serial=serial[:-1]+[ptrs,serial[-1]]
    def apply_space(self,number,continuous=False):               #申請使用空間，return 可用空間房號(串列)，共number個
        serial =self.file_space_configuration_serial   # 讀取登記表
        get=[]
        #print('目前的空間登記表:',serial)
        #---------------------------------------處理前面的
        c=0
        while c<len(serial)-1 and number>0:
            deal=serial[c]
            if type(deal)==int and not continuous:
                get.append(deal)
                number-=1
            elif type(deal)==tuple:
                total=(deal[1]-deal[0])//1024
                if total>number:
                    get.append((deal[0], deal[0] + 1024 * number))
                    serial[0]=(deal[0]+1024*number,deal[1])
                    number=0
                    break                 #滿足了，跳出迴圈
                elif not continuous:
                    get.append(deal)
                    number-=total
            if not continuous:
                del serial[0]
            else:c+=1
        #若前面的空間不足
        if number>0:
            if number==1:
                get.append(serial[-1])
            else:
                get.append((serial[-1],serial[-1]+1024*number))
            serial[-1]+=1024*number
       # print('給空間:',get)
        return get
    def release_space(self,abort_serial):             #FILE釋出不用的空間房號
        serial = self.file_space_configuration_serial  # 讀取登記表
        self.file_space_configuration_serial=serial[:-1]+abort_serial+[serial[-1]]
    def save_configuration(self):
        if self.save_configuration_lock==0:
            self.save_configuration_lock=1
            file_describe_configuration=self.fdc
            file_space_configuration=self.fsc
            #-------------------------------------先存登記表
            while True:
                byte=serial_to_text(self.file_describe_configuration_serial).encode()
                n=len(byte)
                if n>file_describe_configuration.space_manaager.now_max_size():
                    need_number=(file_describe_configuration.space_manaager.now_max_size()-n)//1024+1
                    get=self.apply_space(need_number)
                    file_describe_configuration.space_manaager.serial+=get
                    file_describe_configuration.space_manaager.save()
                else:
                    # --------------------------------------------------------------------存空間表
                    byte2 = serial_to_text(self.file_space_configuration_serial).encode()
                    n2 = len(byte2)
                    if n2 > file_space_configuration.space_manaager.now_max_size():
                        need_number = (file_space_configuration.space_manaager.now_max_size() - n) // 1024 + 1
                        get = self.apply_space(need_number)
                        file_space_configuration.space_manaager.serial += get
                        file_space_configuration.space_manaager.save()
                    else:
                        file_describe_configuration.write(byte, 0)
                        file_space_configuration.write(byte2, 0)
                        break
            self.save_configuration_lock=0
#-----------------------------------------------------------------------------------------------------------------------以下為可供外界使用函數
    def fopen(self,filepath,mode=1,encoding='binary'):           #0:無操作,1:找不到檔案就強制建立
        if filepath=='':return self.root
       # print('開啟:',filepath)
        ptr=self.__get_file_ptr(filepath,operate=mode)
       # print('!!!!!!!!!!!',ptr)
        if ptr==-1:return ptr
        file=FILE(self,ptr,encoding=encoding,encrypt=self.encrypt)
        if file.type==0:    #代表是資料夾
           # print('return folder')
            return FOLDER(self,ptr,encrypt=self.encrypt)
      #  print('return file')
        return file
    def __get_file_ptr(self,filepath,operate=0):       #operate 0:無操作,1:未找到則建立，2:找到後從資料夾移除
        def listdir(nowfolder,k):
          #  print('列出nowfolder內容:',nowfolder.listdir())
            ptr=nowfolder.get_file_ptr(box[k])
           # print('得到的ptr:',ptr)
            if ptr==-1:
                if operate==1 and k==len(box)-1:
                   # print('創造:',box[k])
                    ptr=nowfolder.CreatFile(box[k])
                return ptr
            if k==len(box)-1:
                if operate==2:
                    nowfolder.DeleteFile(box[k])
                return ptr
            else:
               # print('確認listdir:',ptr)
                f=FOLDER(self,ptr,encrypt=self.encrypt)
                if f.type==1:return -1
                return listdir(f,k+1)
        box=filepath.replace('\\','/').split('/')
        file_ptr=listdir(self.root,0)
        return file_ptr
    def __relatively_to_absolute(self,filepath):
        filepath=filepath.replace('\\','/').rstrip('/')
        if filepath=='VDisk:':
            filepath+='/'
        if ':/' not in filepath:                       #絕對路徑
            filepath=f'{self.work_folder}/{filepath}'
        k=filepath.index(':/')
        return filepath[k+2:]
    def listdir_all(self):
        file_list,total_size=self.__package_file('',self)
        return [item[1] for item in file_list]
    def listdir(self,folder_path='',info=False):                    #列出該目錄下檔案
        folder_path=self.__relatively_to_absolute(folder_path)
        if folder_path=='':result=self.root.listdir(fptr=info)
        else:
            fptr=self.__get_file_ptr(folder_path)
            if fptr==-1:
                result=fptr
            else:
                folder=FOLDER(self,fptr,encrypt=self.encrypt)
                result=folder.listdir(fptr=info)
        if not info:return result
        box=[]
        for name,ptr in result:
            file=FILE(self,ptr,encrypt=self.encrypt)
            file.name=name
            box.append(file)
        return box
    def mkdir(self,path):
        path=self.__relatively_to_absolute(path)
        f=self.fopen(path)
        if f.file_size>0:return -1            #若是path不合格，return -1
        f.set_type(0)
        return FOLDER(self,f.ptr,encrypt=self.encrypt)
    def rmdir(self, foldername):
        self.remove(self.__relatively_to_absolute(foldername))
    def getcwd(self):
        return self.work_folder
    def rename(self, filepath1, filepath2):
        filepath1=self.__relatively_to_absolute(filepath1)
        filepath2=self.__relatively_to_absolute(filepath2)
        #--------------------------------------------
        filename1=filepath1.split('/')[-1]
        filename2=filepath2.split('/')[-1]
        #--------------------------------------------
        folderpath1=filepath1[:-len(filename1)-1]
        folder1=self.fopen(folderpath1,mode=0)
        folderpath2= filepath2[:-len(filename2)-1]
        folder2=self.fopen(folderpath2,mode=0)
        #-------------------------------------------
        if type(folder1)==FOLDER and type(folder2)==FOLDER:
            folder1.MoveFile_to_AnotherFolder(filename1,filename2,folder2)
            return True
        return False
    def remove(self,filepath):                 #刪除資料夾或檔案
        ptr=self.__get_file_ptr(self.__relatively_to_absolute(filepath),operate=2)
        return ptr
    def chdir(self, foldername):
        foldername=self.__relatively_to_absolute(foldername)
        if self.isdir(foldername):
            self.work_folder = foldername.rstrip('/')
            return
        raise Exception()
    def isfile(self, filepath):
        if filepath=='':return False
       # print('確認:',self.__relatively_to_absolute(filepath))
        file=self.fopen(self.__relatively_to_absolute(filepath),mode=0)
        return type(file)==FILE
    def isdir(self, folderpath):
        folderpath=self.__relatively_to_absolute(folderpath)
        if folderpath=='':#根目錄
            return True
        file = self.fopen(folderpath,mode=0)
        return type(file) == FOLDER
    def getsize(self, filepath):
        file=self.fopen(self.__relatively_to_absolute(filepath),mode=0)
        return file.file_size
    def open(self, filepath,mode=None,encoding=None):
        filepath = self.__relatively_to_absolute(filepath)
        if encoding==None:
            if mode in (None,'wb','rb','ab'):
                encoding='binary'
            elif mode in ('r','w','a'):
                encoding='utf-8'
        return self.fopen(filepath,encoding=encoding)
    #---------------------------------------------------------------------real,virtual磁碟內容互換
    def __package_file(self,file_path,disk):
        def package_file(folderpath):  # 包裝指令
            size = 0
            o = disk.listdir(folderpath)
            if folderpath!='':
                file_list.append((0,folderpath,folderpath[pf_k:]))
                folderpath+='/'
            for i in o:
                filepath = folderpath + i
                if disk.isdir(filepath):
                    size += package_file(filepath)
                elif disk.isfile(filepath):
                    file_list.append((1,filepath,filepath[pf_k:]))
                    size += disk.getsize(filepath)
            return size
        file_list = []
        filename=file_path.split('/')[-1]
        pf_k=len(file_path[:-len(filename)])
        if disk.isfile(file_path):
            return [(1,file_path,file_path[pf_k:])],disk.getsize(file_path)
        elif disk.isdir(file_path):
            total_size = package_file(file_path)
            return file_list,total_size
    def __move_files(self,disk1,filepath1,disk2,parent_folder='',progress_func=None):
        if progress_func=='default':
            progress_func=Default_progress_bar
        file_list,total_size=self.__package_file(filepath1,disk1)
        if parent_folder!='':
            parent_folder=parent_folder.rstrip('/')+'/'
        now_size=0
        next_progress=20
        time_box=[]
        st=time()
        for ftype,filepath,filename in file_list:
            if ftype==0:
                disk2.mkdir(parent_folder+filename)
            elif ftype==1:
              #  print('filepath:',filepath)
                rf=disk1.open(filepath,'rb')
               # print('to:',parent_folder+filename)
                wf=disk2.open(parent_folder+filename,'wb')
                r_size=2**20                    #寫入尺寸為1MB
                code=rf.read(r_size)
                while len(code)>0:
                    wf.write(code)
                    now_size+=len(code)
                    code = rf.read(r_size)
                    if progress_func!=None and now_size//r_size>next_progress:
                        time_box.append(time()-st)
                        st=time()
                        next_progress+=20
                        average_speed=r_size*20*len(time_box)/sum(time_box)
                        speed_hint=f'speed:{display_size(average_speed)}/s'
                        remain_hint=f'remain:{int((total_size-now_size)/average_speed)}s'
                        progress_func(now_size,total_size,hint=' '*(20-len(speed_hint))+speed_hint+' '*(15-len(remain_hint))+remain_hint)
                        time_box=time_box[-10:]
                rf.close()
                wf.close()
        if progress_func == 'default':
            print()
    def input(self,real_filepath,parent_folder='',progress_func='default'):    #從外部匯入檔案
        if progress_func == 'default':
            print('input:',real_filepath)
        self.__move_files(self.__rdisk,real_filepath,self,parent_folder,progress_func)
    def output(self,virtual_filepath,parent_folder='',progress_func='default'):   #從內部匯出檔案到外部
        if progress_func == 'default':
            print('output:',virtual_filepath)
        self.__move_files(self,virtual_filepath,self.__rdisk,parent_folder,progress_func)
    def close(self):
        self.f.close()
if __name__ == '__main__':
    disk=Disk()
   # disk.format()
    t=Terminal(disk)
    t.mainloop()
    #f=disk.fopen('new.txt')
    #f2=disk.fopen('new2.txt')
#    f.get_info()
    #byte=open('good2.png','rb').read()
    #byte2=open('NodeMCU-32S-details-3.jpg','rb').read()
   # t=time()
   # disk.mkdir('folder1')
   # disk.input('folder1/new.png','good2.png')
   # disk.input('void.txt', 'test.txt')
    #print('當前可用登記表:',disk.file_describe_configuration_serial)
   # print('當前可用空間表:', disk.file_space_configuration_serial)
   # disk.input('new2.jpg','NodeMCU-32S-details-3.jpg')
   # #print('當前可用登記表:', disk.file_describe_configuration_serial)
   # print('當前可用空間表:', disk.file_space_configuration_serial)
   # disk.input('folder1\\new2.jpg', 'NodeMCU-32S-details-3.jpg')
   # disk.remove('new2.jpg')
    #print('當前可用登記表:', disk.file_describe_configuration_serial)
  #  print('當前可用空間表:', disk.file_space_configuration_serial)
   # for i in range(6):
    #    print('--------------------------------')
   #     disk.input(f'new{i}.png', 'good2.png')
   # print('當前可用空間表:', disk.file_space_configuration_serial)
   # print(disk.listdir('1'))
   # print(disk.listdir('folder2'))
    #disk.output('folder1/new.png','new.png')
    #print(time()-t)
    #disk.input('void.txt','test.txt')
    #disk.output('void.txt','test2.txt')
    #disk.input('new2.jpg','NodeMCU-32S-details-3.jpg')
    #disk.output('new2.jpg','new100.png')
    #t=time()
   # disk.input('Apple.mp4','ss.mp4')
    #disk.output('Apple.mp4','banana.mp4')
    #print(time()-t)2353*19*writer.pyfrom threading import Lock
from os import mkdir,listdir
from os.path import isfile,isdir

GB=2**30

class FWriter:
    def __init__(self,disk_folder_path,slice_size=3*GB):   #切片大小為3GB
        disk_folder_path=disk_folder_path.replace('\\','/').rstrip('/')
        self.__disk_folder_path=disk_folder_path
        if not isdir(disk_folder_path):
            mkdir(disk_folder_path)
        self.__fs=[]
        self.__expand_disk(0)      #載入第一可寫順序檔案
        k=1
        while isfile(f'{disk_folder_path}/{k}.dk'):
            self.__fs.append(open(f'{disk_folder_path}/{k}.dk','rb+'))
            k+=1
        self.__slice_size=slice_size
        self.__lock=Lock()
    def __expand_disk(self,max_order):
        k=len(self.__fs)
        while k<=max_order:
            dk_name=f'{self.__disk_folder_path}/{k}.dk'
            if not isfile(dk_name):
                open(dk_name, 'wb').close()
            self.__fs.append(open(dk_name,'rb+'))
            k+=1
    def write(self,dptr,content):
        self.__lock.acquire()
        f_order=dptr//self.__slice_size
        wptr=dptr%self.__slice_size
        write_len=0
        content_len=len(content)
        result_n=0
        while write_len<content_len:
            if f_order>=len(self.__fs):
                self.__expand_disk(f_order)
            f=self.__fs[f_order]
            f.seek(wptr, 0)
            slice_code=content[write_len:write_len+self.__slice_size-wptr]
            wptr=0
            result_n += f.write(slice_code)
            write_len += len(slice_code)
            f_order+=1
        self.__lock.release()
        return result_n
    def read(self,dptr,num):
        self.__lock.acquire()
        f_order = dptr // self.__slice_size
        rptr = dptr % self.__slice_size
        content_box=[]
        while num>0:
            if f_order >= len(self.__fs):    #無內容可讀
                break
            f = self.__fs[f_order]
            f.seek(rptr, 0)
            slice_content=f.read(num)
            rptr=0
            content_box.append(slice_content)
            num-= len(slice_content)
            f_order += 1
        self.__lock.release()
        return b''.join(content_box)
    def close(self):
        for f in self.__fs:
            f.close()148*111*__init__.pyfrom vm.virtual_disk import VDisk
from vm.real_disk import RDisk
from vm.terminal import Terminal
from vm.tool import get_host_ip
39660*011*__pycache__1588*120*crypt.cpython-37.pycB
    e                 @   sp   dddZ dd ZedkrldZdZeedZe eed Zeeeeek d	Z	e ee	d
 ee	Z
ee
 d
S )    c       
      C   s   t | }t| }t |}t|}||| d  }|t| | }||| 7 }||d |t|  7 }dd t||D }	t|	S )Nc             S   s   g | ]\}}||A qS  r   ).0abr   r   (C:\Users\allen\Desktop\py\VM\vm\crypt.py
<listcomp>
   s    zxor_bytes.<locals>.<listcomp>)listlenzipbytes)
contentpasswordZstart_pZcontent_bytesZcontent_lengthpassword_bytesZp_lenZpassword_boxZ
link_timesZ	void_byter   r   r   	xor_bytes   s    r   c             C   s   dd }t | dkrd} xt | dk r6| t| d7 } qW t| }x$tt |D ]}||  |7  < qNW ||}xt ||k r||}qpW t|S )Nc             S   sb   g }xXt dD ]L}xFt t| d | D ].}|| | | |d |  | |  A d  q(W qW |S )N         )ranger	   append)r   Zvoid_passwordr   ir   r   r   generate   s
    2z#generate_password.<locals>.generater   s   123   s   azbycx)r	   r   r   r   r   )r   lengthr   r   r   r   r   r   generate_password   s    r   __main__sQ   hello world,this is my first program. In this project,I make an encrypt function.s   alld      N)r   )r   r   __name__stringr   Z	password2encryptprintr	   kZdecryptr   r   r   r   <module>   s   

2808*124*real_disk.cpython-37.pycB
    1e                 @   sR   d dl mZmZmZmZmZmZmZmZ d dl	m
Z
mZmZmZ G dd dZdS )    )listdirmkdirrmdirgetcwdrenameremovechdirpopen)isdirisfilegetsizeisabsc               @   s   e Zd Zdd Zdd Zd ddZdd	 Zd
d Zdd Zdd Z	dd Z
dd Zdd Zdd Zdd Zdd Zdd Zdd ZdS )!RDiskc             C   s   t  dd| _d S )N\/)r   replacework_folder)self r   ,C:\Users\allen\Desktop\py\VM\vm\real_disk.py__init__   s    zRDisk.__init__c             C   s   t |r|S | j d| S )Nr   )r   r   )r   filepathr   r   r   __relatively_to_absolute   s    zRDisk.__relatively_to_absoluteNc             C   s2   |d kr| j }| |}|d kr*t| j S t|S )N)r   _RDisk__relatively_to_absoluter   )r   
foldernamer   r   r   r      s    

zRDisk.listdirc             C   s   |  |}t|st| d S )N)r   r
   r   )r   r   
folderpathr   r   r   r      s    
zRDisk.mkdirc             C   s   t | | d S )N)r   r   )r   r   r   r   r   r      s    zRDisk.rmdirc             C   s   | j S )N)r   )r   r   r   r   r      s    zRDisk.getcwdc             C   s   t | || | d S )N)r   r   )r   	filename1	filename2r   r   r   r      s    zRDisk.renamec             C   s   t | | d S )N)r   r   )r   r   r   r   r   r      s    zRDisk.removec             C   s&   t |r"| |ddd| _d S )Nr   r   )r
   r   r   rstripr   )r   r   r   r   r   r      s    zRDisk.chdirc             C   s   t | |S )N)r   r   )r   r   r   r   r   r   !   s    zRDisk.isfilec             C   s   t | |S )N)r
   r   )r   r   r   r   r   r
   #   s    zRDisk.isdirc             C   s   t | |S )N)r   r   )r   r   r   r   r   r   %   s    zRDisk.getsizec             O   s   |  |}t|f||S )N)r   open)r   r   argskwargsr   r   r   r   '   s    
z
RDisk.openc             C   s$   t  }t| j t|}t| |S )N)r   r   r   r	   )r   ZcommandZmypathresultr   r   r   r	   *   s
    
zRDisk.popenc             C   s   d S )Nr   )r   r   r   r   close0   s    zRDisk.close)N)__name__
__module____qualname__r   r   r   r   r   r   r   r   r   r   r
   r   r   r	   r#   r   r   r   r   r      s   
r   N)osr   r   r   r   r   r   r   r	   Zos.pathr
   r   r   r   r   r   r   r   r   <module>   s   (3924*123*terminal.cpython-37.pycB
    r~e                 @   s"   d dl m Z  dZG dd dZdS )    )timeu{  
終端機指令:

help                               查看可用指令
system                             查看系統資訊

input    filepath                  將filepath存入虛擬磁碟
output   v_filename r_filename     將v_filename從虛擬磁碟匯出，並命名為r_filename
mkdir    foldername                創建foldername資料夾
cd       foldername                進入資料夾
cd..                               離開資料夾
dir      foldername                查看foldername底下所有檔案資料
info     filename                  查看filename資訊
remove   filename                  移除filename


c               @   s0   e Zd ZdddZdddZdd Zd	d
 ZdS )Terminalr   c             C   s.   || _ d| _d| _g | _g | _d| _|| _d S )Nz	/\:*?"<>| r   )diskbanlist
folderpathlog_textoutputerrormode)selfr   r    r   +C:\Users\allen\Desktop\py\VM\vm\terminal.py__init__   s    zTerminal.__init__   c             C   sH   | j t ||f | jdkr(t| n| jdkr>| j| || _d S )Nr   r   )r   appendr   r   printr	   r
   )r   msgr
   r   r   r   log   s    
 

 zTerminal.logc       
      C   s  | j t d|f |d}|d dkr:ttdd n|d dkrt  | dt	tj
  | dt	tjtj tj   nF|d d	kr| jd
d }| jd t| d  | _nt|dkr|d dkr| d| j| j nt|dkr|d }d}t|dkr0| d d}xD| jD ]:}||kr8|dkrVd}n| d| d|  d}q8W |dkr|}n | jdkr|}n| jd
 | }td| |dk r| jj|dd}|d dkr|dkr|jdkr| d n
| d n| j| |d dkrL|dkr>|jdkr>|| _n
| d n|d dkr|dkr|jdkr| d| j| n
| d n8|d dkr|dkr| |  n
| d n|d dkr |dkr| j| n
| d n|d dkrrt|d s.t|d r\| jj| j|d td}	|	dkrp| d  n| |d  d! n^t|dkr|d d"krt|d r| d# n&| j||d }	|	dkr| d$ tdtj d%| j d&dd d S )'Nr    helpr   )endsystemu   已使用空間:u   系統所占空間:zcd../r   dir
u   檔案名稱不可為空!   z/\u   檔案名稱"u    "中包含不可使用的字元:zfpath:)r   mkdiru   該資料夾已存在u   此為已存在的檔案名稱Zcdu   該資料夾不存在!infou   該檔案不存在!removeinput)progress_funcu   無效的虛擬路徑u
   不存在!r	   u   無法覆蓋現有的檔案!u   該虛擬檔案不存在#z>>)r   r   r   splitr   t_cmdr   recalculate_sizer   esize	used_size	fdsc_sizefdc_sizefsc_sizer   lenjoinlistdirr   fopentyper   get_infor    pathisfileisdirr!   progress_barr	   	disk_path)
r   stringcmdfolderfilenameZ
check_codeiZfpathfileZcheckr   r   r   operate"   s    
 &







   
 
  
 
 
zTerminal.operatec             C   s   |  d x|t }|dkrP q|dkr8| j  d| _q|d}|d dkrzt| j|d }|jdkrt|	dd q|  | qW d S )	Nr   exitformatr   r   r   ptrr   )
r=   r!   r   r?   r   r$   FILEr0   r   read)r   abr<   r   r   r   mainlooph   s    
 


zTerminal.mainloopN)r   )r   )__name__
__module____qualname__r   r   r=   rE   r   r   r   r   r      s   

Fr   N)r   r%   r   r   r   r   r   <module>   s   1130*119*tool.cpython-37.pycB
    ڃe                 @   s>   d dl m Z mZmZmZmZmZ dd ZdddZdd	 Zd
S )    )socketAF_INET
SOCK_DGRAMtimeoutgethostnamegethostbynamec             C   sF   x@t dD ]4}dd| d  }| |kr
t| | d d|  S q
W d S )N         
   )GBMBKBZbit)rangeround)sizeibase r   'C:\Users\allen\Desktop\py\VM\vm\tool.pydisplay_size   s    r   2    c             C   sR   t ||  | }tdd|  d||   dtd|  | d d|  dd	 d S )
Nz
process:[u   ▇ z]  d   r	   z%  z  )end)intprintr   )ZnowtotalwidthhintZprocessr   r   r   Default_progress_bar   s    r!   c              C   sZ   t tt} | d y| d |  d }W n tk
rL   tt }Y nX | 	  |S )Nr	   )z8.8.8.8P   r   )
r   r   r   Z
settimeoutZconnectZgetsocknamer   r   r   close)sZipr   r   r   get_host_ip
   s    


r%   N)r   r   )	r   r   r   r   r   r   r   r!   r%   r   r   r   r   <module>   s    
27463*127*virtual_disk.cpython-37.pycB
    0ّe                 @   s  d dl mZmZ d dlmZmZmZ d dlmZmZ d dl	m
Z
 d dlmZmZ d dlmZ d(dd	Zd
d Zdd Zdd Zdd Zdd Zdd Zdd Zdd Zdd ZG dd dZG dd dZG d d! d!ZG d"d# d#ZG d$d% d%Zed&kre  Z!e"e!Z#e#$  d'S ))    )pathlistdir)time	localtimesleep)	xor_bytesgenerate_password)RDisk)display_sizeDefault_progress_bar)FWriter2   c             C   sL   t ||  | }tdd|  d||   dt|  dt|  dd d S )Nz[# z] / )end)intprintesize)now_size
total_sizesizei r   /C:\Users\allen\Desktop\py\VM\vm\virtual_disk.pyprogress_bar   s    r   c             C   s:   t | }|j d|j d|j d|j d|j d|j S )Nr   r   :)r   Ztm_yearZtm_monZtm_mdayZtm_hourZtm_minZtm_sec)tntr   r   r   nowtime   s    r    c             C   sN   d}xDt t|D ]4}t| dd|   d}|dk r| d||  S qW d S )N)BZKBZMBZGBZTBZPBZEB   
   i   r   )rangelenround)r   Z	size_unitr   Zcsizer   r   r   r      s
    r   c             C   s   |  dd }| d t| d  }d}x|D ]}||d}q.W t }| d| |krh| d| S d}x$| d| d| |kr|d7 }qnW | d| d| S )N.   z	/\:*?"<>|_)splitr%   replacer   )filenameformatnamebanlistr   ocr   r   r   legel_filename   s    
 r3   c             C   s0   t t| d}dd}|dt|  | S )Nzutf-80   )strr   encoder%   )r   sar   r   r   format_file_size#   s    
r:   c       	      C   sP   dd }dd }dd }|| || || || t | t d || S )Nc             S   s   | rdnd dS )N1r4   zutf-8)r7   )isfiler   r   r   format_isfile(   s    z file_info.<locals>.format_isfilec             S   s8   t t| d}dd}|dt|  |dd   S )Nzutf-8r4   r#   i)r6   r   r7   r%   )r   nr9   r   r   r   format_time*   s    
zfile_info.<locals>.format_timec             S   s(   d d}|  d}||dt|   S )Nr4   zutf-8C   )r7   r%   )locationr9   Zlocation_byter   r   r   format_file_location.   s    

z'file_info.<locals>.format_file_locationr   )r:   )	r<   build_tZlast_update_tZlast_read_t	file_sizeZfile_locationr=   r?   rB   r   r   r   	file_info'   s    rE   c             C   sn   |  d}g }xZ| d | dD ]D}d|krX|d}|t|d t|d f q"|t| q"W |S )N*,-r   r)   )indexr+   appendr   )textkboxr   r2   r   r   r   text_to_serial8   s    

 rN   c             C   sf   d}xP| D ]H}t |tkr*|| d7 }q
t |tkr
||d  d|d  d7 }q
W |d d d S )Nr   rG   r   rH   r)   r(   rF   )typer   tuple)serialrK   r   r   r   r   serial_to_textB   s    
 rR   c             C   s   i }g g  }}xR| D ]J}t |tkr8|||< || qt |tkr|||d < ||d  qW |  x|D ]}|||  qpW t|S )Nr   )rO   r   rJ   rP   sortcombine_serial)rQ   getrM   Znboxr   r   r   r   sort_serialJ   s    


rV   c             C   s   ddg}g }d}x|t | k rt| | tkrD| | | | d f}n| | }|d |d krj|d |d< n&||d |d f |d |d g}|d7 }qW ||d |d f |d= |S )Nr   Znoi   r)   )r%   rO   r   rJ   )rQ   Ztemresultr2   dealr   r   r   rT   X   s     rT   c               @   s,   e Zd Zdd Zdd Zdd Zdd Zd	S )
Space_Serialc             C   s   || _ || _|g| _xl|dkr|jr.td| | jj|d}|jrRtd| t|d d }| j	| ||dd 7 }qW t
|| _d S )Nr   zextend_ptr:zutf-8zfetch:r5      )ptrdiskptrsdebugr   !file_describe_space_configurationreaddecoder   rJ   rN   rQ   )selfr\   r[   
extend_ptrrA   fetchr   r   r   __init__i   s    


zSpace_Serial.__init__c             C   sZ   d}xH| j D ]>}t|tkr&|d7 }qt|tkr||d |d  d 7 }qW t|d S )Nr   r)   i   )rQ   rO   r   rP   )rb   totalr   r   r   r   now_max_sizez   s    
zSpace_Serial.now_max_sizec             C   s  |   }||kr>|| d d }| j|}|  j|7  _n6||d k rt|d d }g }d}x|dkrDt| j| tkr|d8 }nt| j| tkr:| j| d | j| d g}x8|dkr|d |d  dkr|d8 }|d  d7  < qW |d |d  dkr:| j| d |d f| j|< ||d |d f |d7 }qbW || j|d  7 }| jd | | _| j| | 	  d S )Ni   r)   r   )
rg   r\   apply_spacerQ   rO   r   rP   rJ   release_spacesave)rb   r   rg   ZneedZapply_serialabort_serialr2   rX   r   r   r   resize   s2    
zSpace_Serial.resizec             C   sj  t | j| _t| jd}t|}| jg| j }d}x|dkr|dkrT|d8 }n|d8 }|dkrrd||d < n,||d  dkr| j ||d < |	d |dkr| jj
|| d t||d  |d d   n<| jj
|| t||d  ||d d |d d    |d7 }q8W |d t|k rJ| j||d d  |d|d  | _| j  d S )Nzutf-8r   r@   q   r)   .   r(   )rT   rQ   rR   r7   r%   r[   r]   r\   register_describe_configurationrJ   r_   writer:   !unregister_describe_configurationsave_configuration)rb   byter>   r]   r2   r   r   r   rj      s,     

2<zSpace_Serial.saveN)__name__
__module____qualname__re   rg   rl   rj   r   r   r   r   rY   h   s   rY   c               @   s4   e Zd Zdd Zdd Zdd Zdd Zd	d
 ZdS )FDSCc             C   s   || _ || _| j j|dd}|t|dd g| _xT| jd dkr| j j| jd d}| jt| j j| jd d dd q:W |  | _	d S )NrZ   zutf-8rn   =   r(   r   r5   )
r\   unitfr`   ra   r   dptrsrJ   _FDSC__get_max_termmax_term)rb   r\   r[   ry   rd   r   r   r   re      s    0zFDSC.__init__c             C   s   t | jd | j S )Nr)   )r%   r{   ry   )rb   r   r   r   Z__get_max_term   s    zFDSC.__get_max_termc             C   sl   || j d< | jj| j d d t| j d  | j d | jj| j d d t| j d  |  | _d S )Nr(   rn   r   )r{   r\   rz   rp   r:   rJ   r|   r}   )rb   r[   r   r   r   extend   s
    
$$zFDSC.extendc             C   sp   || j krt| td|d }|| j }|| j|  }||d d  }| j | |d  | }| jj||S )Nu   此位置被占用rZ   )r{   r   	Exceptionry   r\   rz   rp   )rb   r[   contentorderpageoffsetZoffset2dptrr   r   r   rp      s    

z
FDSC.writec             C   sj   |d }|| j  }|| j |  }| j| |d  }| jjrZtd| j td| td| | jj|dS )NrZ   z
self.dptr:zpage:zdptr:)ry   r{   r\   r^   r   rz   r`   )rb   r[   r   r   r   r   r   r   r   r`      s    


z	FDSC.readN)rt   ru   rv   re   r|   r   rp   r`   r   r   r   r   rw      s
   	rw   c               @   sr   e Zd ZdddZdd Zdd Zdd	 Zd
d Zdd ZdddZ	dd Z
dd Zdd ZdddZdd ZdS )FOLDERNc             C   sV   || _ || _|| _t| j | j| jd| _| jj| _| jj| _g | _|   | 	  d S )N)encrypt)
r\   r[   r   FILEfilerD   rO   rM   _FOLDER__load_contentreload)rb   r\   r[   r   r   r   r   re      s    

zFOLDER.__init__c             C   s   | j   d S )N)r   get_info)rb   r   r   r   r      s    zFOLDER.get_infoc             C   s   | j | || _d S )N)r   set_typerO   )rb   tyr   r   r   r      s    zFOLDER.set_typec             C   sT   | j dd}y |d| _d| _| d W n  tk
rN   d| _d| _Y nX d S )Nr   zutf-8Tr   F)r   r`   ra   r   access_rightsr   UnicodeDecodeError)rb   r   r   r   r   Z__load_content   s    zFOLDER.__load_contentc             C   sd   | j dd ddd  }g | _x:tt|D ]*}|| d\}}| j|t|g q2W d S )Nz|**r   |r)   rF   )r   r+   rM   r$   r%   rJ   r   )rb   rM   r   r/   r[   r   r   r   r     s
    zFOLDER.reloadc             C   s   | j rg }x2| jD ](\}}|d| ddt|  qW |dd d|}| jdkrx| jd | jj| _| j	t
| | j|d |d}|   || jkrt| t| j tdntd	d S )
Nr   rF   zutf-8z|**    r)   r   stopu   folder儲存失敗)r   rM   rJ   r7   r:   joinrO   r   r   set_sizer%   rp   ra   r   r   r   r   )rb   rM   r/   r[   rs   r   r   r   r   rj     s$    $






zFOLDER.saveTc             C   sF   t | jdkr|   |s@g }x| jD ]}||d  q&W |S | jS )Nr   )r%   rM   r   rJ   )rb   fptrrM   r   r   r   r   r     s     zFOLDER.listdirc             C   sV   y@| j d| d}| j d|}t| j |d |d  }W n   d}Y nX |S )Nr   rF   r)      r(   )r   rI   r   )rb   r-   ZnkZpkr[   r   r   r   get_file_ptr'  s     
zFOLDER.get_file_ptrc             C   s   | j s
dS d}x|D ]}||d}qW |   | jd}t| jd}t }td|||d|}| j	j
|| | j||g |   |S )Nr(   z	/\:*?"<>|r*   r)   Tr   )r   r,   r   r\   ro   rR   rh   r   rE   r   fdscrp   rM   rJ   rj   )rb   r-   r0   r   Z	login_ptrZspace_serialr   Z
login_infor   r   r   	CreatFile1  s     
zFOLDER.CreatFilec             C   s$   x| j D ]}|d |kr|S qW dS )Nr   F)rM   )rb   r-   r   r   r   r   is_existC  s    zFOLDER.is_existc             C   s   |    | |}|s"td dS | j|jkr8||d< nP|   ||}|rh|s^td dS || | j| |j| |  |   |d S )Nu   起始地檔案不存在r(   r   u   目的地檔案名稱已存在r)   )	r   r   r   r[   
DeleteFilerM   removerJ   rj   )rb   	filename1	filename2ZanotherfolderZ	overwriteZ
file1_infoZ
file2_infor   r   r   MoveFile_to_AnotherFolderH  s&    



z FOLDER.MoveFile_to_AnotherFolderc             C   sz   |    d}x.| jD ]$}|d |kr|d }| j| qW |   |dkrvt| j|| jd}|jd | j	| |S )Nr(   r   r)   )r   )
r   rM   r   rj   r   r\   r   space_manaagerrl   rq   )rb   r/   r   r   rz   r   r   r   r   ]  s    zFOLDER.DeleteFile)N)T)T)rt   ru   rv   re   r   r   r   r   rj   r   r   r   r   r   r   r   r   r   r   r      s   





r   c               @   sf   e Zd ZdddZdd Zdd Zd	d
 Zdd ZdddZdddZ	dddZ
dddZdd ZdS )r   binaryNc       	   
   C   s<  || _ t|| _|| _|| _| j j| _| j| j}|d}t	|dksRt
dt|tksft
dyvt|d | _t|dd | _t|dd | _t|dd	 | _t|d	d
 | _t|d
d }|dd }W n2 tk
r } ztd| |W d d }~X Y nX t| j | j||| _| d | d d S )Nzutf-8rZ   zfetch errorz
type errorr   r)            rn   rx   zfetch error:read_t)r\   r   r[   encodingr   r_   r   r`   ra   r%   AssertionErrorrO   r6   rC   update_tr   rD   r   r   rY   r   seek_FILE__set_info)	rb   r\   r[   r   r   rd   rc   rA   er   r   r   re   l  s.    




zFILE.__init__c             C   s   || _ | d d S )NrO   )rO   r   )rb   r   r   r   r   r     s    zFILE.set_typec             C   s   || _ | d d S )Nr   )rD   r   )rb   r   r   r   r   r     s    zFILE.set_sizec             C   s   |dkrdt | jdf}nZ|dkr@dt tt df}n8|dkrbdt tt df}n|dkrxd	t| jf}| j| j	|d  |d
  d S )NrO   r   zutf-8r   r   r   r   r   r   r)   )
r6   rO   r7   r   r   r:   rD   r   rp   r[   )rb   stater8   r   r   r   Z
__set_info  s        zFILE.__set_infoc             C   s   g }| d| j  | dddg| j   | dt| j  | dt| j  | dt| j  | d| j  | d	| jj	  d

|S )Nu   檔案登記位址:u   檔案型態:u	   資料夾u   檔案u   建立時間:u   上次修改時間:u   上次存取時間:u   檔案大小:u   儲存空間序列
)rJ   r[   rO   r    rC   r   r   rD   r   rQ   r   )rb   infor   r   r   r     s    zFILE.get_infor   c             C   s   || | _ d S )N)pen)rb   r   Zrelativer   r   r   r     s    z	FILE.seekc       	      C   s<  |d kr|| _ | jdkr$|| j}t|}| j | | jkr`| j | | _| j| j | d | jd krt	|| j| j }|t|kst
dd}d}d}x|t| jjk r| jj| }|| j krBt|tkr| jj||||d   |d7 }nFt|tkr|d |d  }| jj|d ||||   ||7 }nt|tkr|d | j kr|d | j  }| jj|d | |d |  |d7 }njt|tkr|d |d  }|| | j kr|| j |  }| jj|d | j |  |d |  ||7 }|d7 }|t|d krP qW |  j |7  _ | d |S )Nr   r   u   加密錯誤r   i   r)   r   )r   r   r7   r%   rD   r   rl   r   r   r   r   rQ   rO   r   r\   rz   rp   rP   )	rb   rs   r   r>   r2   rL   skiprX   Zw_sizer   r   r   rp     sT     



 
 
& 
z
FILE.writec             C   s   |dkrxt d|}| ||}|g}||8 }x@|dkrlt d|}| |}t|dkrXP || ||8 }q.W d|S d}| ||}|g}x$t|dkr| |}|| qW d|S )Nr   i   r   )min_FILE__readr%   rJ   r   )rb   r>   r   r_sizecodeZ
total_byter   r   r   r`     s(    






z	FILE.readc                s.   fdd}|d kr|_ j }|dkr8jj  }nt|jj  }|}g  d}d}xb|tjjk rjj| }|j krt|tkrtd|}	|||	 ||	8 }n8t|tkrt|d |d  |}	||d |	 ||	8 }nt|tkr@|d j kr6t|d j  |}	||d |	 |	 ||	8 }|d7 }njt|tkr|d |d  }
||
 j krt|
j |  |}	||d j |  |	 ||	8 }||
7 }|d7 }|dkr^P q^W  j |7  _ 	d d
 }jd krt|j|}|t|kstdjd	kr*|j}|S )
Nc                s     jj| | d S )N)rJ   r\   rz   r`   )r   r>   )rs   rb   r   r   	disk_read  s    zFILE.__read.<locals>.disk_readr   i   r)   r   r   u   解密錯誤r   )r   rD   r   r%   r   rQ   rO   r   rP   r   r   r   r   r   r   ra   )rb   r>   r   r   Zread_penZ	read_sizer2   r   rX   r   Zt_sizeZ	read_byter   )rs   rb   r   Z__read  s^     





 

zFILE.__readc             C   s   d | _ d | _d S )N)r\   r   )rb   r   r   r   close   s    z
FILE.close)r   N)r   )N)r   N)r   N)rt   ru   rv   re   r   r   r   r   r   rp   r`   r   r   r   r   r   r   r   k  s   



3

6r   c               @   s  e Zd ZdFddZdd Zdd Zd	d
 Zdd Zdd ZdGddZ	dd Z
dHddZdd Zdd ZdIddZdJdd Zd!d" Zd#d$ ZdKd%d&Zd'd( Zd)d* Zd+d, Zd-d. Zd/d0 Zd1d2 Zd3d4 Zd5d6 Zd7d8 ZdLd9d:Zd;d< ZdMd=d>ZdNd@dAZdOdBdCZ dDdE Z!dS )PVDiskr   Nc             C   sz   d| _ || _d| _d| _|d kr0t|ddnd | _t | _| jdkrNd| _t	
| jsntd| j |   |   d S )	NFzVDisk:i   zutf-8i   r   zdefault.disku   創建:)r^   	disk_pathwork_folder	fdsc_unitr   r7   r   r	   _VDisk__rdiskr   isdirr   _VDisk__create_new_disk_VDisk__load_disk)rb   r   passwordr   r   r   re   $  s    
zVDisk.__init__c             C   s   | j d }d}xH| j D ]>}t|tkr0|d7 }qt|tkr|d |d  }||7 }qW | jjd | _| jj| _	| j
j| _|| | _d S )Nr(   r   i   r)   rZ   )file_space_configuration_serialrO   r   rP   r_   r}   Z	fdsc_sizefscrD   Zfsc_sizefdcZfdc_size	used_size)rb   r   r   r   Zg_sizer   r   r   recalculate_size2  s    



zVDisk.recalculate_sizec             C   s@   |    g }|dt| j  |d| jj  d|S )Nz
used_size:zaccess_rights:r   )r   rJ   r
   r   rootr   r   )rb   Zinfo_boxr   r   r   r   D  s
    zVDisk.get_infoc             C   s   |    |   d S )N)r   r   )rb   r   r   r   r.   J  s    zVDisk.formatc             C   s  | j | j t| j}t }|dtd|||dd |dtd|||dt| jd  d |dtd|||t	| jd d  d
 t| jd d	  d |d
td|||dt| jd d  d || jd d || jd d	 | jd d  d
  |  d S )Nr   Tz---rZ      rF      i   i   i  Fi   s   512*)r   mkdirr   r   r   rp   rE   r   r   r%   r7   r   )rb   rz   r   r   r   r   Z__create_new_diskM  s    
*F.*zVDisk.__create_new_diskc             C   s   t | j| _t| d| jd| _t| d| _t| d| _t	| j
dd | _t	| j
dd | _t| d| jd| _d| _|   d S )Nr   )ry   rZ   r   i  )r   )r   r   rz   rw   r   r_   r   r   r   rN   r`   ra   "file_describe_configuration_serialr   r   r   r   save_configuration_lockr   )rb   r   r   r   Z__load_diskZ  s    zVDisk.__load_diskr)   c             C   s   | j }g }| jj}xt||k r|d }t|dkr<|d= nt|dkrX|d  d7  < ||kr| jt| jd ddd d }| j| | jj}q|| jjkr|	| qW |dkr|d S |S )Nr   r)   rZ      T)
continuous)
r   r_   r}   r%   rh   r   r   r   r{   rJ   )rb   numberrQ   rU   r}   Zwant_use_ptrrc   r   r   r   ro   f  s$     
 z%VDisk.register_describe_configurationc             C   sN   | j }t|tkr0|d d | |d g | _ n|d d ||d g | _ d S )Nr(   )r   rO   list)rb   r]   rQ   r   r   r   rq   x  s    z'VDisk.unregister_describe_configurationFc             C   sF  | j }g }d}x|t|d k r|dkr|| }t|tkrT|sT|| |d8 }nt|tkr|d |d  d }||kr||d |d d|  f |d d|  |d f|d< d}P n|s|| ||8 }|s|d= q|d7 }qW |dkrB|dkr||d  n||d |d d|  f |d  d| 7  < |S )Nr   r)   i   r(   )r   r%   rO   r   rJ   rP   )rb   r   r   rQ   rU   r2   rX   rf   r   r   r   rh   }  s6    




zVDisk.apply_spacec             C   s&   | j }|d d | |d g | _ d S )Nr(   )r   )rb   rk   rQ   r   r   r   ri     s    zVDisk.release_spacec       	      C   s  | j dkrd| _ | j}| j}xt| j }t|}||j kr|j | d d }| 	|}|j j
|7  _
|j  q t| j }t|}||j kr|j | d d }| 	|}|j j
|7  _
|j  q ||d ||d P q W d| _ d S )Nr   r)   i   )r   r   r   rR   r   r7   r%   r   rg   rh   rQ   rj   r   rp   )	rb   Zfile_describe_configurationZfile_space_configurationrs   r>   Zneed_numberrU   Zbyte2Zn2r   r   r   rr     s.    

zVDisk.save_configurationr   c             C   sX   |dkr| j S | j||d}|dkr(|S t| ||| jd}|jdkrTt| || jdS |S )Nr   )operater(   )r   r   r   )r   )r   _VDisk__get_file_ptrr   r   rO   r   )rb   filepathmoder   r[   r   r   r   r   fopen  s      
zVDisk.fopenr   c                s4    fdd| ddd jd}|S )Nc                s   |   | }|dkr@dkr<|t d kr<|  | }|S |t d krjdkrf|  |  |S t|jd}|jdkrdS ||d S d S )Nr(   r)   r"   )r   )r   r%   r   r   r   r   rO   )Z	nowfolderrL   r[   rz   )rM   r   r   rb   r   r   r     s    
 z%VDisk.__get_file_ptr.<locals>.listdir\r   r   )r,   r+   r   )rb   r   r   Zfile_ptrr   )rM   r   r   rb   r   Z__get_file_ptr  s    zVDisk.__get_file_ptrc             C   sT   | ddd}|dkr"|d7 }d|kr:| j d| }|d}||d d  S )Nr   r   zVDisk:z:/r"   )r,   rstripr   rI   )rb   r   rL   r   r   r   Z__relatively_to_absolute  s    
zVDisk.__relatively_to_absolutec             C   s   |  d| \}}dd |D S )Nr   c             S   s   g | ]}|d  qS )r)   r   ).0itemr   r   r   
<listcomp>  s    z%VDisk.listdir_all.<locals>.<listcomp>)_VDisk__package_file)rb   	file_listr   r   r   r   listdir_all  s    zVDisk.listdir_allc       
      C   s   |  |}|dkr"| jj|d}n4| |}|dkr:|}nt| || jd}|j|d}|s^|S g }x0|D ](\}}t| || jd}	||	_||	 qhW |S )Nr   )r   r(   )r   )	_VDisk__relatively_to_absoluter   r   r   r   r   r   r/   rJ   )
rb   Zfolder_pathr   rW   r   ZfolderrM   r/   r[   r   r   r   r   r     s     
 
 zVDisk.listdirc             C   s>   |  |}| |}|jdkr"dS |d t| |j| jdS )Nr   r(   )r   )r   r   rD   r   r   r[   r   )rb   r   rz   r   r   r   r     s    


 
zVDisk.mkdirc             C   s   |  | | d S )N)r   r   )rb   
foldernamer   r   r   rmdir  s    zVDisk.rmdirc             C   s   | j S )N)r   )rb   r   r   r   getcwd  s    zVDisk.getcwdc       	      C   s   |  |}|  |}|dd }|dd }|d t| d  }| j|dd}|d t| d  }| j|dd}t|tkrt|tkr|||| dS dS )Nr   r(   r)   r   )r   TF)r   r+   r%   r   rO   r   r   )	rb   	filepath1Z	filepath2r   r   Zfolderpath1Zfolder1Zfolderpath2Zfolder2r   r   r   rename  s    

zVDisk.renamec             C   s   | j | |dd}|S )Nr"   )r   )r   r   )rb   r   r[   r   r   r   r     s    zVDisk.removec             C   s.   |  |}| |r$|d| _d S t d S )Nr   )r   r   r   r   r   )rb   r   r   r   r   chdir  s
    

zVDisk.chdirc             C   s,   |dkrdS | j | |dd}t|tkS )Nr   Fr   )r   )r   r   rO   r   )rb   r   r   r   r   r   r<     s     zVDisk.isfilec             C   s0   |  |}|dkrdS | j|dd}t|tkS )Nr   Tr   )r   )r   r   rO   r   )rb   
folderpathr   r   r   r   r   $  s
    
zVDisk.isdirc             C   s   | j | |dd}|jS )Nr   )r   )r   r   rD   )rb   r   r   r   r   r   getsize*  s    zVDisk.getsizec             C   s:   |  |}|d kr,|dkr d}n|dkr,d}| j||dS )N)NwbrbZabr   )rwr9   zutf-8)r   )r   r   )rb   r   r   r   r   r   r   open-  s    
z
VDisk.openc                s    fddg | dd }t|d t|   |rbd||d  fg |fS  |r||}|fS d S )Nc                s   d}  | }| dkr6d| | d  f | d7 } x\|D ]T}| | } |r`||7 }q< |r<d||d  f | |7 }q<W |S )Nr   r   r   r)   )r   rJ   r   r<   r   )r   r   r1   r   r   )r\   r   package_filepf_kr   r   r   7  s    



z*VDisk.__package_file.<locals>.package_filer   r(   r)   )r+   r%   r<   r   r   )rb   Z	file_pathr\   r-   r   r   )r\   r   r   r   r   Z__package_file6  s    

zVDisk.__package_filec          	   C   s  |dkrt }| ||\}}|dkr2|dd }d}d}	g }
t }xR|D ]H\}}}|dkrp|||  qL|dkrL||d}||| d}d	}||}xt|dkr|| |t|7 }||}|d kr|| |	kr|
	t |  t }|	d7 }	|d t|
 t
|
 }d
t| d}dt|| |  d}|||ddt|  | ddt|   | d |
dd  }
qW |  |  qLW |dkrt  d S )Ndefaultr   r   r      r)   r   r   i   zspeed:z/szremain:r8   r   r5   )Zhinti)r   r   r   r   r   r   r`   r%   rp   rJ   sumr
   r   r   r   )rb   Zdisk1r   Zdisk2parent_folderprogress_funcr   r   r   Znext_progressZtime_boxstZftyper   r-   ZrfZwfr   r   Zaverage_speedZ
speed_hintZremain_hintr   r   r   Z__move_filesM  sD    


2
zVDisk.__move_filesr   c             C   s*   |dkrt d| | | j|| || d S )Nr   zinput:)r   _VDisk__move_filesr   )rb   Zreal_filepathr   r   r   r   r   inputr  s    
zVDisk.inputc             C   s*   |dkrt d| | | || j|| d S )Nr   zoutput:)r   r   r   )rb   Zvirtual_filepathr   r   r   r   r   outputv  s    
zVDisk.outputc             C   s   | j   d S )N)rz   r   )rb   r   r   r   r   z  s    zVDisk.close)r   N)r)   )F)r)   r   )r   )r   F)NN)r   N)r   r   )r   r   )"rt   ru   rv   re   r   r   r.   r   r   ro   rq   rh   ri   rr   r   r   r   r   r   r   r   r   r   r   r   r<   r   r   r   r   r   r   r   r   r   r   r   r   r   #  s>   


!



	
%

r   __main__N)r   )%osr   r   r   r   r   Zvm.cryptr   r   vm.real_diskr	   vm.toolr
   r   Z	vm.writerr   r   r    r   r3   r:   rE   rN   rR   rV   rT   rY   rw   r   r   r   rt   ZDiskr\   Terminalr   Zmainloopr   r   r   r   <module>   s8   

R-  9  [
2361*121*writer.cpython-37.pycB
    :e	                 @   sB   d dl mZ d dlmZmZ d dlmZmZ dZG dd dZ	dS )    )Lock)mkdirlistdir)isfileisdiri   @c               @   s6   e Zd ZdddZdd Zdd Zdd	 Zd
d ZdS )FWriter   c             C   s   | ddd}|| _t|s(t| g | _| d d}x>t| d| drz| jt	| d| dd |d7 }q>W || _
t | _d S )N\/r      z.dkzrb+)replacerstrip_FWriter__disk_folder_pathr   r   _FWriter__fs_FWriter__expand_diskr   appendopen_FWriter__slice_sizer   _FWriter__lock)selfZdisk_folder_pathZ
slice_sizek r   )C:\Users\allen\Desktop\py\VM\vm\writer.py__init__   s    
zFWriter.__init__c             C   s^   t | j}xN||krX| j d| d}t|s<t|d  | jt|d |d7 }qW d S )Nr
   z.dkwbzrb+r   )lenr   r   r   r   closer   )r   Z	max_orderr   Zdk_namer   r   r   Z__expand_disk   s    

zFWriter.__expand_diskc             C   s   | j   || j }|| j }d}t|}d}xv||k r|t| jkrP| | | j| }||d |||| j |  }	d}|||	7 }|t|	7 }|d7 }q0W | j   | 	||}
||
krt
d| d| |S )Nr   r   zdptr:z  content_len:)r   acquirer   r   r   r   seekwritereleaseread	Exception)r   dptrcontentf_orderZwptrZ	write_lenZcontent_lenZresult_nfZ
slice_codeZcontent2r   r   r   r      s*    






zFWriter.writec             C   s   | j   || j }|| j }g }x^|dkr|t| jkr<P | j| }||d ||}d}|| |t|8 }|d7 }q$W | j   d	|S )Nr   r       )
r   r   r   r   r   r   r!   r   r    join)r   r#   Znumr%   ZrptrZcontent_boxr&   Zslice_contentr   r   r   r!   3   s     







zFWriter.readc             C   s   x| j D ]}|  qW d S )N)r   r   )r   r&   r   r   r   r   D   s    zFWriter.closeN)r   )__name__
__module____qualname__r   r   r   r!   r   r   r   r   r   r      s
   
r   N)
Z	threadingr   osr   r   os.pathr   r   GBr   r   r   r   r   <module>   s   330*123*__init__.cpython-37.pycB
    ۃe                  @   s4   d dl mZ d dlmZ d dlmZ d dlmZ dS )    )VDisk)RDisk)Terminal)get_host_ipN)Zvm.virtual_diskr   Zvm.real_diskr   Zvm.terminalr   Zvm.toolr    r   r   +C:\Users\allen\Desktop\py\VM\vm\__init__.py<module>   s   2878*17*main.pyfrom vm import VDisk,get_host_ip
from sys import argv
from os import listdir,remove,system
from os.path import isfile

vm_hint='''
-d disk_name                           指定disk_name為開啟的磁碟(默認為帶.disk檔名的磁碟)
-i r_filepath (at v_parent_folder)     將r_filepath輸入磁碟，v_parent_folder為虛擬資料夾名稱
-o v_filepath (at r_parent_folder)     將v_filepath輸出磁碟，r_parent_folder為實體資料夾名稱
-l foldername                          展開虛擬機foldername的資料夾
-p password                            附加磁碟密碼
-creat                                 創建磁碟
-control                               進入磁碟操作模式
'''

if len(argv)==1:
    print(vm_hint)
else:
    disk_path=''
    input_files=[]
    output_files=[]
    listdir_folders=[]
    password=None
    creat=False
    control=False
    k=1
    while k<len(argv):
        if argv[k]=='-d':
            k+=1
            disk_path=argv[k]
        elif argv[k]=='-i':
            k+=1
            input_files.append([argv[k],''])
            if len(argv)>k+1 and argv[k+1]=='at':
                input_files[-1][1]=argv[k+2]
                k+=2
        elif argv[k]=='-o':
            k+=1
            output_files.append([argv[k],''])
            if len(argv)>k+1 and argv[k+1]=='at':
                output_files[-1][1]=argv[k+2]
                k+=2
        elif argv[k]=='-l':
            k+=1
            if k >= len(argv):
                listdir_folders.append('')
            else:
                listdir_folders.append(argv[k])
        elif argv[k]=='-p':
            k+=1
            password=argv[k]
        elif argv[k]=='-creat':
            creat=True
        elif argv[k]=='-control':
            control=True
        k+=1
    if creat and isfile(disk_path):
        remove(disk_path)
    if disk_path=='':
        for i in listdir():
            if i.split('.')[-1]=='disk':
                disk_path=i
        if disk_path=='':
            disk_path='default.disk'
        print('disk path:',disk_path)
    vd=VDisk(disk_path,password)
    print(vd.get_info())
    if vd.root.access_rights:
        for filepath,parent_folder in input_files:
            vd.input(filepath,parent_folder,'default')
        for foldername in listdir_folders:
            print(vd.listdir(foldername))
        for filepath, parent_folder in output_files:
            vd.output(filepath, parent_folder, 'default')
        if control:
            disk_name=disk_path.split('.')[0]
            url=f'https://{get_host_ip()}:3030?disk={disk_name}&pd={password}'
            print(f'開啟連線:   {url}\n')

            system(f'start chrome /incognito "{url}"')
            system('server')
    else:
        print('密碼錯誤，存取被拒')